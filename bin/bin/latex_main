#!/usr/bin/env bash

# Run latexmk
latexmk $1

# Get filename without extension
base="${1%.*}"

# Create main.tex
cp "${base}.tex" "main.tex"

# Create \input{} filepaths array
inputs=($(grep -E '\\input{.*}' $1 | sed 's/.*{\([^]]*\)}.*/\1/g'))

# Create \input{} line number array
inputlines=($(grep -n '\\input{.*}' $1 | cut -f1 -d: ))

# Loop over each element of both array to create a sed statement
# which replaces the \input{} lines with the contents of the referenced file
for ((i=0;i<${#inputlines[@]};++i)); do
   printf -v s '%s%s\n%s\n' "$s" "${inputlines[i]}r ${inputs[i]}" "${inputlines[i]}d"
done

# Run sed 
sed -i.bak -e "$s" main.tex

# Find bibliography line number
bibline="$(grep -n '\\bibliography{.*}' main.tex | cut -f1 -d: )"

# Replace \bibliography{} with formatted contents of
# .bbl file generated by latexmk
sed -i.bak -e "${bibline}r ${base}.bbl" -e "${bibline}d"  main.tex

# Clean up intermediate files
rm main.tex.bak
