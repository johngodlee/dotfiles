# muttrc
# vim: foldmethod=marker

source ~/.mutt/mutt_colours
source ~/.mutt/aliases
source ~/.mutt/gpg.rc

set move = no
set realname = "John Godlee"
set signature = "~/.mutt/signature"
set folder = "~/.mail"

# PGP GPG {{{
set pgp_default_key = E2388D6F0290C660224F6439215C0880610719F7 
set pgp_use_gpg_agent = yes

# }}}

# Text editor {{{
set editor = 'vim'
set charset = "utf-8"
unset record

# Ability to change headers manually in text editor 
set edit_headers = yes
set autoedit = yes

# better line wrapping in mutt and vim
set text_flowed

# }}}

# Pager View Options {{{
set pager_index_lines = 0  # number of index lines to show
set pager_context = 3      # number of context lines to show
set pager_stop             # don't go to next message automatically
set menu_scroll            # scroll in menus
set tilde                  # show tildes like in vim
unset markers              # no ugly plus signs
set mark_old = no          # Don't add Old flags, just keep N
set mailcap_path = ~/.mailcap
auto_view text/html
alternative_order text/plain text/html

# }}}

# Status bar {{{
set status_chars  = " *%A"
set status_format = "───[Folder: %f]───[%r%m messages%?n? (%n new)?%?d? (%d to delete)?%?t? (%t tagged)?]───%>─%?p?( %p postponed )?───"
# }}}

# Index {{{
set date_format = "%b-%d"
set index_format = "[%Z] %X %M %-20.20F -- %s %* %[%Y_%m_%d] - %[%H:%M]"
set sort = threads                         # like gmail
set sort_aux = last-date-received          # like gmail
set uncollapse_jump                        # don't collapse on an unread message
set sort_re                                # thread based on regex
set reply_regexp = "^(([Rr][Ee]?(\[[0-9]+\])?: *)?(\[[^]]+\] *)?)*"
# }}}

# Pager {{{
macro index C "<copy-message>?<toggle-mailboxes>" "copy a message to a mailbox"
macro index M "<save-message>?<toggle-mailboxes>" "move a message to a mailbox"
# }}}

# Sidebar {{{
set sidebar_visible = yes
set sidebar_format = "%B %* [%N]%S"

## Don't abbreviate folders in sidebar
set sidebar_short_path
set sidebar_delim_chars = "/"

# Gmail mailboxes
mailboxes "+--- gmail --------"
mailboxes +johngodlee@gmail.com/INBOX # always have inbox at top of list
mailboxes `find ~/.mail/* -maxdepth 1 -mindepth 1 | sort | cut -d/ -f5- | sed 's/^/+/' | sed '/notmuch/d' | sed '/temporary/d' | sed '/INBOX/d' | sed '/riseup/d' | tr '\n' ' '`

# Riseup mailboxes
mailboxes "+--- riseup --------"
mailboxes +johngodlee@riseup.net/INBOX # always have inbox at top of list
mailboxes `find ~/.mail/* -maxdepth 1 -mindepth 1 | sort | cut -d/ -f5- | sed 's/^/+/' | sed '/INBOX/d' | sed '/temporary/d' | sed '/gmail/d' | tr '\n' ' '`

# Notmuch search mailbox
mailboxes "+--- search --------"
mailboxes +temporary/search

# }}}

# Always include original message in reply and always reply to sender
set include = yes
set fast_reply

# Ask if unsent message should be kept as postponed
set postpone = ask-yes

# Multiple account setup {{{

# Default to gmail setup
source ~/.mutt/accounts/gmail

# Folder hooks
folder-hook gmail/*      source ~/.mutt/accounts/gmail
folder-hook riseup/*     source ~/.mutt/accounts/riseup

# Macros for switching accounts - sources a separate config when a folder is opened
macro index } '<sync-mailbox><enter-command>source ~/.mutt/accounts/gmail<enter><change-folder>!<enter>'
macro index { '<sync-mailbox><enter-command>source ~/.mutt/accounts/riseup<enter><change-folder>!<enter>'
# }}}

# Keybindings {{{

## Disable arrow keys
bind generic,pager,editor,index <Up>       noop
bind generic,pager,editor,index <Down>     noop
bind generic,pager,editor,index <Left>     noop
bind generic,pager,editor,index <Right>    noop

## Tagging and manipulating basics
bind  index,pager c       mail            # compose
bind  generic     x       tag-entry       # Select Conversation
bind  index       x       tag-thread      # Select Conversation
bind  pager       x       tag-message     # Select Conversation
bind  index,pager *       flag-message    # Star a message
bind  index,pager a       group-reply     # Reply all
bind  index,pager d       delete-message  # Delete message
bind  index,pager D      noop
bind  index,pager l       copy-message    # Label
bind  index       v       save-message    # Move to
bind  index       /       noop
bind  index       /       search-reverse  # Search reverse (bottom up) as default 
bind  index       <Esc>/  search

## Sidebar interaction
bind  index,pager B  sidebar-toggle-visible
bind  index,pager >  sidebar-next
bind  index,pager <  sidebar-prev
bind  index,pager ?  sidebar-open

## Movement 
bind  pager  i  noop
bind  index,pager g noop
bind  index  G  last-entry
bind  index  j  next-entry
bind  index  k  previous-entry
bind  pager  k  previous-line
bind  pager  j  next-line
bind  pager  J  next-entry
bind  pager  K  previous-entry 
bind  pager  q  exit
bind  pager  v  view-attachments
bind  pager  G  bottom
bind  pager  gg top

## Fast movement
bind editor <space> noop

macro index,pager gi "<change-folder>=johngodlee@gmail.com/INBOX<enter>" "Go to Gmail inbox"
macro index,pager gr "<change-folder>=johngodlee@riseup.net/INBOX<enter>" "Go to Riseup inbox"

bind  index,pager h  help

# View full Mutt manual using less in mutt 
macro index,pager \# "<shell-escape>less ~/.mutt/manual.txt<enter>" "Show Mutt documentation"

# Run offlineimap in Mutt
macro index,pager @ "<enter-command>unset wait_key<enter><shell-escape>offlineimap -o -u quiet &<enter><sync-mailbox>" "Run offlineimap"

# Search using notmuch
macro index \\ "<enter-command>unset wait_key<enter><shell-escape>mutt-notmuch-py ~/.mail/temporary/search<enter><change-folder-readonly>+temporary/search<enter>" "search mail (using notmuch)"

# Run offlineimap sync
macro index + '<shell-escape>offlineimap -o<enter>'

# View HTML attachment in default web browser

# }}}
